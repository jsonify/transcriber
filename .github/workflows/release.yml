name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Build full release
      run: make release
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: releases/*.zip
        name: Release v${{ steps.version.outputs.VERSION }}
        body: |
          ## Transcriber v${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“¦ Download & Installation
          
          **Quick Install:**
          1. Download `transcriber-${{ steps.version.outputs.VERSION }}.zip`
          2. Extract the zip file
          3. Run `./install.sh` to install system-wide
          
          **Manual Install:**
          ```bash
          sudo cp transcriber /usr/local/bin/
          ```
          
          ### ðŸ“‹ What's Included
          
          - `transcriber` - The main CLI binary (signed with Speech Recognition entitlements)
          - `transcriber.entitlements` - Required entitlements file
          - `install.sh` - Automated installation script
          - `README.md` - Documentation
          
          ### âœ¨ Usage
          
          ```bash
          transcriber --help
          transcriber audio.mp3
          transcriber --list-languages
          ```
          
          **Requirements:** macOS with Speech Recognition framework
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
